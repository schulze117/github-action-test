name: Stealth Scraper (XVFB + UC)

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: 'URL to scrape'
        required: true
        default: 'https://api.ipify.org/' 
      proxy_string:
        description: 'Proxy (ip:port or user:pass@ip:port)'
        required: false
        default: ''

jobs:
  stealth-run:
    runs-on: ubuntu-latest
    env:
      PY_COLORS: "1"

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Set up Python 3.10
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable xvfb
          sudo apt-get clean

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install seleniumbase pyautogui python-xlib

      - name: Install SeleniumBase Driver
        run: |
          seleniumbase install chromedriver

      - name: Run Scraper Script
        run: |
          # 1. Start building the arguments string
          ARGS="--url ${{ inputs.target_url }} --headless false --xvfb true --incognito true --block-images true"
          
          # 2. Handle Proxy Input Safely
          RAW_PROXY="${{ inputs.proxy_string }}"
          
          if [ -n "$RAW_PROXY" ]; then
            # Clean the proxy: 
            # - Remove 'http://' and 'https://' prefixes
            # - Remove double quotes (") and single quotes (')
            CLEAN_PROXY=$(echo "$RAW_PROXY" | sed 's|http://||g' | sed 's|https://||g' | tr -d '"' | tr -d "'")
            
            # Append to arguments without adding extra quotes
            ARGS="$ARGS --proxy $CLEAN_PROXY"
          fi

          echo "Running with arguments: $ARGS"
          
          # 3. Run Python (Variable expansion happens here, no quotes around $ARGS)
          python scrape.py $ARGS

      - name: Upload Artifacts (Screenshots/Logs)
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: debug-screenshots
          path: |
            *.png
            latest_logs/
